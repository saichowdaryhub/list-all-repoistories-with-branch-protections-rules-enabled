name: Branch Protection Detailed Audit (User Public Repos + Slack + CSV)

on:
  workflow_dispatch:   # only run when manually triggered

jobs:
  audit:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    env:
      ORG_NAME: ${{ github.repository_owner }}   # your GitHub username
      GITHUB_TOKEN: ${{ secrets.BP_PAT }}        # your personal access token
      SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK_URL }}  # Slack webhook URL
      DEBUG: "true"
      PYTHONUNBUFFERED: "1"

    steps:
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"

      - name: Install dependencies
        run: pip install requests

      - name: Run Branch Protection Audit and Generate CSV
        run: |
          python - <<'EOF'
          import os, requests, time, csv

          ORG = os.getenv("ORG_NAME")
          TOKEN = os.getenv("GITHUB_TOKEN")
          SLACK = os.getenv("SLACK_WEBHOOK")
          DEBUG = os.getenv("DEBUG","false").lower()=="true"

          def log(m,l="INFO"): print(f"[{l}] {m}", flush=True)
          def dbg(m): 
              if DEBUG: log(m,"DEBUG")

          H = {"Accept": "application/vnd.github+json"}
          if TOKEN:
              H["Authorization"] = f"Bearer {TOKEN}"

          def get_json(url):
              r = requests.get(url, headers=H, timeout=30)
              dbg(f"GET {url} -> {r.status_code}")
              if r.status_code==200: return r.json()
              if r.status_code==404: return None
              log(f"Failed GET {url} -> {r.status_code}: {r.text[:150]}", "WARN")
              return None

          def list_repos():
              repos, page = [], 1
              while True:
                  data = get_json(f"https://api.github.com/users/{ORG}/repos?per_page=100&page={page}&type=public")
                  if not data: break
                  repos += data
                  if len(data) < 100: break
                  page += 1
              return [r for r in repos if not r.get("archived", False)]

          def get_rules(repo, branch):
              return get_json(f"https://api.github.com/repos/{ORG}/{repo}/rules/branches/{branch}") or []

          def try_get_classic_protection(repo, branch):
              url = f"https://api.github.com/repos/{ORG}/{repo}/branches/{branch}/protection"
              r = requests.get(url, headers=H, timeout=30)
              dbg(f"GET {url} -> {r.status_code}")
              if r.status_code == 200:
                  return r.json()
              return None

          # Start
          repos = list_repos()
          log(f"Total active public repositories found: {len(repos)}")
          for r in repos: log(f"→ {r['name']}")

          # CSV setup
          csv_filename = "branch_protection_audit_summary.csv"
          with open(csv_filename, mode="w", newline="") as csvfile:
              writer = csv.writer(csvfile)
              writer.writerow(["Check", "Classic Protection", "Ruleset", "Required Value"])
              writer.writerow(["Default branch protection exists", "✅", "✅", "Must be protected"])
              writer.writerow(["Require pull request", "✅", "✅", "Must be enabled"])
              writer.writerow(["Required approvals count", "✅", "✅", "Must be 2"])
              writer.writerow(["Restrict deletions", "❌", "✅", "Must be enabled"])
              writer.writerow(["Block force pushes", "❌", "✅", "Must be enabled"])
              log(f"CSV summary written to {csv_filename}")

          # Example logic for Slack summary (simplified)
          if SLACK:
              summary_text = (
                  f"*Branch Protection Audit Summary*\n"
                  f"Repositories analyzed: {len(repos)}\n"
                  f"CSV report generated: `{csv_filename}`"
              )
              payload = {
                  "text": "Branch Protection Audit Results",
                  "blocks": [
                      {"type": "section", "text": {"type": "mrkdwn", "text": summary_text}},
                      {"type": "section", "text": {"type": "mrkdwn", "text": "Download CSV from workflow artifacts."}}
                  ]
              }
              try:
                  r = requests.post(SLACK, json=payload, timeout=30)
                  log(f"Slack summary POST -> {r.status_code}")
                  if r.status_code != 200:
                      log(f"Slack error response: {r.text}", "WARN")
              except Exception as e:
                  log(f"Slack summary POST failed: {e}", "WARN")

          EOF

      - name: Upload CSV Report Artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: branch-protection-audit-summary
          path: branch_protection_audit_summary.csv
          retention-days: 30