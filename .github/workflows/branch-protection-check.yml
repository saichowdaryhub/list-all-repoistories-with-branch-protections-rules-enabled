name: Branch Protection Detailed Audit (User Public Repos + Slack)

on:
  workflow_dispatch:   # Run manually from GitHub Actions tab

jobs:
  audit:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    env:
      ORG_NAME: ${{ github.repository_owner }}
      GITHUB_TOKEN: ${{ secrets.BP_PAT }}
      SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
      SLACK_CHANNEL: ${{ secrets.SLACK_CHANNEL }}   # Use channel ID (e.g. C06AB12345)

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install jq
        run: sudo apt-get install -y jq

      - name: Get list of public repositories
        run: |
          echo "Fetching public repositories for $ORG_NAME..."
          curl -s -H "Authorization: token $GITHUB_TOKEN" \
            "https://api.github.com/users/$ORG_NAME/repos?per_page=100&type=public" \
            | jq -r '.[].name' > repos.txt

          echo "Repositories found:"
          cat repos.txt

      - name: Create CSV header
        run: |
          echo "Check,Classic Protection,Ruleset,Required Value" > results.csv
          echo "Default branch protection exists,‚úÖ,‚úÖ,Must be protected" >> results.csv
          echo "Require pull request,‚úÖ,‚úÖ,Must be enabled" >> results.csv
          echo "Required approvals count,‚úÖ,‚úÖ,Must be 2" >> results.csv
          echo "Restrict deletions,‚ùå,‚úÖ,Must be restricted" >> results.csv

          echo "‚úÖ CSV file created:"
          cat results.csv

      # ---------- SLACK UPLOAD LOGIC -----------
      - name: Send results to Slack
        run: |
          echo "üîç Testing Slack upload method compatibility..."

          # Try uploadV2 first
          uploadv2_response=$(curl -s -X POST \
            -H "Authorization: Bearer $SLACK_BOT_TOKEN" \
            -F "channel_id=$SLACK_CHANNEL" \
            -F "initial_comment=üìä *Branch Protection Audit Results ‚Äî CSV attached*" \
            -F "file=@results.csv" \
            https://slack.com/api/files.uploadV2)

          ok=$(echo "$uploadv2_response" | jq -r '.ok')

          if [ "$ok" = "true" ]; then
            echo "‚úÖ Successfully uploaded using files.uploadV2"
            echo "$uploadv2_response"
          else
            error=$(echo "$uploadv2_response" | jq -r '.error')
            echo "‚ö†Ô∏è files.uploadV2 failed with error: $error"
            echo "‚Ü©Ô∏è Trying legacy files.upload method instead..."

            legacy_response=$(curl -s -X POST \
              -H "Authorization: Bearer $SLACK_BOT_TOKEN" \
              -F "channels=$SLACK_CHANNEL" \
              -F "initial_comment=üìä *Branch Protection Audit Results ‚Äî CSV attached*" \
              -F "file=@results.csv" \
              https://slack.com/api/files.upload)

            echo "Slack API response:"
            echo "$legacy_response"
          fi