name: Branch Protection Detailed Audit (User Public Repos + Slack)

on:
  workflow_dispatch:   # Run manually from GitHub Actions tab

jobs:
  audit:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    env:
      ORG_NAME: ${{ github.repository_owner }}
      GITHUB_TOKEN: ${{ secrets.BP_PAT }}
      SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
      SLACK_CHANNEL: ${{ secrets.SLACK_CHANNEL }}   # Use channel ID (e.g. C06AB12345)

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install jq
        run: sudo apt-get install -y jq

      - name: Get list of public repositories
        run: |
          echo "Fetching public repositories for $ORG_NAME..."
          curl -s -H "Authorization: token $GITHUB_TOKEN" \
            "https://api.github.com/users/$ORG_NAME/repos?per_page=100&type=public" \
            | jq -r '.[].name' > repos.txt

          echo "Repositories found:"
          cat repos.txt


      - name: Create CSV header
        run: |
          echo "Repository,Default Branch,Protected,Require PR,Required Approvals,Restrict Deletions" > results.csv

      - name: Check branch protection for each repo and append to CSV
        env:
          GITHUB_TOKEN: ${{ secrets.BP_PAT }}
          ORG_NAME: ${{ github.repository_owner }}
        run: |
          while read repo; do
            # Get default branch
            default_branch=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
              "https://api.github.com/repos/$ORG_NAME/$repo" | jq -r '.default_branch')

            # Get branch protection (returns 200 if protected, 404 if not)
            protection=$(curl -s -o protection.json -w "%{http_code}" -H "Authorization: token $GITHUB_TOKEN" \
              "https://api.github.com/repos/$ORG_NAME/$repo/branches/$default_branch/protection")

            if [ "$protection" = "200" ]; then
              protected="âœ…"
              require_pr=$(jq -r '.required_pull_request_reviews != null' protection.json)
              if [ "$require_pr" = "true" ]; then
                pr="âœ…"
                approvals=$(jq -r '.required_pull_request_reviews.required_approving_review_count' protection.json)
              else
                pr="âŒ"
                approvals="-"
              fi
              restrict_deletions=$(jq -r '.allow_deletions.enabled' protection.json 2>/dev/null)
              if [ "$restrict_deletions" = "false" ]; then
                restrict="âœ…"
              else
                restrict="âŒ"
              fi
            else
              protected="âŒ"
              pr="-"
              approvals="-"
              restrict="-"
            fi
            echo "$repo,$default_branch,$protected,$pr,$approvals,$restrict" >> results.csv
          done < repos.txt

          echo "âœ… CSV file created:"
          cat results.csv

      # ---------- UPLOAD ARTIFACT & SEND SLACK MESSAGE -----------
      - name: Upload results.csv as artifact
        uses: actions/upload-artifact@v4
        with:
          name: branch-protection-results
          path: results.csv

      - name: Send CSV contents to Slack
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
          SLACK_CHANNEL: ${{ secrets.SLACK_CHANNEL }}
        run: |
          CSV_CONTENT=$(cat results.csv)
          MESSAGE="ðŸ“Š *Branch Protection Audit Results*\n\n$CSV_CONTENT"
          curl -X POST -H "Authorization: Bearer $SLACK_BOT_TOKEN" \
            -H 'Content-type: application/json' \
            --data "{\"channel\": \"$SLACK_CHANNEL\", \"text\": \"$MESSAGE\"}" \
            https://slack.com/api/chat.postMessage