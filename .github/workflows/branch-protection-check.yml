name: Branch Protection Detailed Audit (User Public Repos + Slack)

on:
  workflow_dispatch:   # Run manually from GitHub Actions tab

jobs:
  audit:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    env:
      ORG_NAME: ${{ github.repository_owner }}
      GITHUB_TOKEN: ${{ secrets.BP_PAT }}
      SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
      SLACK_CHANNEL: ${{ secrets.SLACK_CHANNEL }}   # Use channel ID (e.g. C06AB12345)

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install jq
        run: sudo apt-get install -y jq

      - name: Get list of public repositories
        run: |
          echo "Fetching public repositories for $ORG_NAME..."
          curl -s -H "Authorization: token $GITHUB_TOKEN" \
            "https://api.github.com/users/$ORG_NAME/repos?per_page=100&type=public" \
            | jq -r '.[].name' > repos.txt

          echo "Repositories found:"
          cat repos.txt

      - name: Create CSV header
        run: |
          echo "Check,Classic Protection,Ruleset,Required Value" > results.csv
          echo "Default branch protection exists,âœ…,âœ…,Must be protected" >> results.csv
          echo "Require pull request,âœ…,âœ…,Must be enabled" >> results.csv
          echo "Required approvals count,âœ…,âœ…,Must be 2" >> results.csv
          echo "Restrict deletions,âŒ,âœ…,Must be restricted" >> results.csv

          echo "âœ… CSV file created:"
          cat results.csv

      # ---------- UPLOAD ARTIFACT & SEND SLACK MESSAGE -----------
      - name: Upload results.csv as artifact
        uses: actions/upload-artifact@v4
        with:
          name: branch-protection-results
          path: results.csv

      - name: Send workflow run link to Slack
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
          SLACK_CHANNEL: ${{ secrets.SLACK_CHANNEL }}
        run: |
          RUN_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          MESSAGE="ðŸ“Š *Branch Protection Audit Results*\nThe CSV report is available as a workflow artifact.\n<${RUN_URL}|Click here to download the artifact from GitHub Actions.>"
          curl -X POST -H "Authorization: Bearer $SLACK_BOT_TOKEN" \
            -H 'Content-type: application/json' \
            --data "{\"channel\": \"$SLACK_CHANNEL\", \"text\": \"$MESSAGE\"}" \
            https://slack.com/api/chat.postMessage